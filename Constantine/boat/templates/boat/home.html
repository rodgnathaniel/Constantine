{% extends "users/home_base.html" %}
{% load static %}
{% block content %}


<!--#################################################################################################################################
--------------------------HTML------------------------------------------------------------------------------------------------
#####################################################################################################################################-->

    <!-- Setting up canvas -->
    <span class="user_text">Welcome {{ request.user }}</span>
    <canvas id="cnv" class="cnv" width="600" height="370"></canvas>


    <audio src="{% static 'boat/sound/n_song.mp3' %}" id="theme_song"></audio>
    <audio src="{% static 'boat/sound/teleport.wav' %}" id="teleport"></audio>
    <audio src="{% static 'boat/sound/collision_sound.mp3' %}" id="collision"></audio>


    <button id="start_listening" style="display:none"></button>   
    <span id="speech_results" style="display:none"></span>


    <div class="modal_content">
        <button class="close" id="close_computer" style="display:none"></button>
        <a href="{% url 'login' %}">Login</a>
        <a href="{% url 'register' %}">Register</a>
    </div>


    <div class="modal_game">
        <button class="close" id="close_nes"></button>
        {% for mode in modes %}
        <a href="{% url 'boat:iguana' %}?game_mode={{mode.id}}">Iguana Jump - {{mode.name}}</a>
        {% endfor %}
        <a href="{% url 'boat:constantine' %}">Constantine</a>
    </div>


    <div class="modal_logout">
        <button class="close" id="close_logout" style="display:none"></button>
        <a id="save" href="#">Save Game</a>
        <a id="load" href="#">Load Game</a>
        <a href="{% url 'logout' %}">Logout</a>
    </div>


    <div class="modal_lucario">
        <button class="close" id="close_lucario" style="display:none"></button>
        <span>I need your help..</span>
        <button id="help" >Help Lucario</button>
    </div>

    <div class="modal_load">
        <button class="close" id="close_load"></button>
        {% for state in save_states %}
        <a href="{% url 'boat:iguana' %}?save_state={{mode.id}}"> - {{save_state.id}}</a>
        {% endfor %}
    </div>
 

    <!-- load images to be drawn -->
    <img id="hero" src="{% static 'boat/player.png' %}" style="display:none"/>
    <img id="spook" src="{% static 'boat/spook3.png' %}" style="display:none"/>
    <img id="spooky" src="{% static 'boat/spook.png' %}" style="display:none"/>
    <img id="spook4" src="{% static 'boat/spook4.png' %}" style="display:none"/>
    <img id="blue" src="{% static 'boat/blue.png' %}" style="display:none"/>
    <img id="duskball" src="{% static 'boat/duskball.png' %}" style="display:none"/>
    <img id="spook5" src="{% static 'boat/spook5.png' %}" style="display:none"/>
    <img id="lucario" src="{% static 'boat/lucario.png' %}" style="display:none"/>
    <img id="windows" src="{% static 'boat/windows.png' %}" style="display:none"/>


<!--#################################################################################################################################
--------------------------JAVA-SCRIPT------------------------------------------------------------------------------------------------
#####################################################################################################################################-->
<script type="text/javascript">

    var start_listening = document.querySelector('#start_listening');
    var r = document.querySelector('#speech_results');


    //buttons
    var close_computer = document.querySelector('#close_computer')
    var close_nes = document.querySelector('#close_nes')
    var close_logout = document.querySelector('#close_logout')
    var close_lucario = document.querySelector('#close_lucario')
    var close_load = document.querySelector('#close_load')
    var help = document.querySelector('#help')
    var save = document.querySelector('#save')
    var load = document.querySelector('#load')


    //declare canvas
    let cnv = document.querySelector('#cnv');
    cnv.backgroundColor = 'red';
    let width = cnv.width
    let height = cnv.height
    let ctx = cnv.getContext('2d');


    // // declare images 
    var hero = document.querySelector("#hero");
    var spook = document.querySelector("#spook");
    var spooky = document.querySelector("#spooky");
    var spook4 = document.querySelector("#spook4");
    var spook5 = document.querySelector("#spook5");
    var blue = document.querySelector("#blue");
    var lucario_img = document.querySelector("#lucario");
    var windows = document.querySelector("#windows");


    //game data 
    var stair_collision = 1
    var cabnet_collision = 0
    var rail2_collision = 0
    var duskball_collision = 2
    var painting_collision = 0
    var haunted_collision = 1
    var lucario_collision = 0

    var duskball_is = false
    var haunted_painting_is = false
    var lucario_is = true
    var computer_on = false



    //declare sounds
    let theme_song = document.querySelector('#theme_song') 
    let teleport = document.querySelector('#teleport') 
    let collision = document.querySelector('#collision') 

    //functions to play sounds
    var play_music = function(){
        theme_song.play()
        play_music.disabled = true
    }
    var teleport_sound = function(){
        teleport.play()
    }
    var collision_sound = function(){
        collision.play()
    }


    //user sprite
    let player = {
        px: 170,
        py: 220,
        vx: 0,
        vy: 0,
        width: 50,
        height: 50
    };

    let lucario = {
        py: 300,
        px: 520,
        vx: 0,
        vy: 0,
        width: 50,
        height: 60
    }

    let dusk_ball = {
        px: 50,
        py: 285,
        width: 18,
        height: 18
    }

    let ceiling = {
        px: 0,
        py: 0,    
        width: 100,
        height: 90
    }

    let cabnet = {
        px: 100,
        py: 0,    
        width: 70,
        height: 90
    }

    let ceiling3 = {
        px: 170,
        py: 0,    
        width: 115,
        height: 90
    }

    let ceiling2 = {
        px: 280,
        py: 0,    
        width: 240,
        height: 70
    }

    let painting = {
        px: 525,
        py: 0,
        width: 85,
        height: 50
    }

    let haunted_painting = {
        px: 552,
        py: 30,
        width: 55,
        height: 31
    }

    let stairs = {
        px: 380,
        py: 60,    
        width: 35,
        height: 75
    }

    let rail = {
        px: 388,
        py: 135,
        width: 105,
        height: 7.5
    }

    let rail2 = {
        px: 370,
        py: 75,
        width: 7.5,
        height: 60
    }

    let computer = {
        px: 0,
        py: 100,    
        width: 17,
        height: 7
    }

    let computer_screen = {
        px: 13,
        py: 68,    
        width: 36,
        height: 18
    }

    let tv = {
        px: 272,
        py: 155,    
        width: 35,
        height: 50
    }
    let tv_screen = {
        px: 277,
        py: 176,    
        vx: 0,
        vy: 0,
        width: 36,
        height: 22
    }

    let nes = {
        px: 272,
        py: 242,    
        vx: 0,
        vy: 0,
        width: 50,
        height: 10
    }

    let bed = {
        px: 37,
        py: 242,    
        width: 25,
        height: 5
    }

    let left_wall = {
        px: 0,
        py: 0,    
        width: 2,
        height: 370
    }

    let right_wall = {
        px: 598,
        py: 0,    
        width: 2,
        height: 370
    }

    let floor = {
        px: 0,
        py: 368,    
        width: 600,
        height: 2
    }
    





//-----------------------JS-FUNCTIONS------------------------------------------------------------------------------------------------------- 


    //send users game data to database
    function save_game() {        
        axios.post("{% url 'boat:save_state' %}",
                {
                    duskball_is: duskball_is,
                    haunted_painting_is: haunted_painting_is,
                    lucario_is: lucario_is,
                    computer_on: computer_on,
                    stair_collision: stair_collision,
                    cabnet_collision: cabnet_collision,
                    rail2_collision: rail2_collision,   
                    duskball_collision: rail2_collision,
                    painting_collision: rail2_collision,
                    haunted_collision: rail2_collision,
                    lucario_collision: lucario_collision,
                }, {
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                }
            ).then(function(response) {
            })
    }
    var computer_contact = function() {
        document.querySelector(".modal_content").style.display = "flex";
    }

    var nes_contact = function() {
        document.querySelector(".modal_game").style.display = "flex";
    }

    var bed_contact = function() {
        document.querySelector(".modal_logout").style.display = "flex";
    }
    var lucario_contact = function() {
        document.querySelector(".modal_lucario").style.display = "flex";
    }

    close_computer.onclick = function() {
        document.querySelector(".modal_content").style.display = "none";
    }

    close_nes.onclick = function() {
        document.querySelector(".modal_game").style.display = "none";
    }

    close_logout.onclick = function() {
        document.querySelector(".modal_logout").style.display = "none";
    }
    close_lucario.onclick = function() {
        document.querySelector(".modal_lucario").style.display = "none";
    }
    close_load.onclick = function() {
        document.querySelector(".modal_load").style.display = "none";
    }
    help.onclick = function() {
        close_lucario.onclick()
        help.disabled = true
        computer_contact.disabled = true
        lucario.py -= 235
        lucario.vx = -.6
    }
    save.onclick = function(){
        save_game()
        document.location.reload()
    }
    load.onclick = function(){
        document.querySelector(".modal_logout").style.display = "none";
        document.querySelector(".modal_load").style.display = "flex";
    }
    var lucario_mission = function(){
    }


    //function for drawing objects on canvas
    function draw() {
        // clear canvas each time function is called
        ctx.clearRect(0, 0, cnv.width, cnv.height)
        if (stair_collision >= 1){
            ctx.drawImage(spook, tv_screen.px, tv_screen.py, tv_screen.width, tv_screen.height);
        }
        if (stair_collision >= 2){
            ctx.drawImage(spooky, computer_screen.px, computer_screen.py, computer_screen.width, computer_screen.height);
        }
        if (stair_collision >= 3 && cabnet_collision >= 10 && rail2_collision >= 10) {
            duskball_is = true
            if (duskball_collision >= 1){
                dusk_ball.px = 320
                dusk_ball.py = 70
            }
            ctx.drawImage(duskball, dusk_ball.px, dusk_ball.py, dusk_ball.width, dusk_ball.height);
        }
        if (painting_collision >= 10){
            if (duskball_collision >= 2){
                haunted_painting_is = true
                ctx.drawImage(spook4, tv_screen.px, tv_screen.py, tv_screen.width, tv_screen.height);
                ctx.drawImage(blue, computer_screen.px, computer_screen.py, computer_screen.width, computer_screen.height);
                ctx.drawImage(spook5, haunted_painting.px, haunted_painting.py, haunted_painting.width, haunted_painting.height);
            }
        }

        if (haunted_collision >= 1 && stair_collision === 1) {
                lucario_is = true
                ctx.drawImage(lucario_img, lucario.px, lucario.py, lucario.width, lucario.height);
        }
        if (lucario_collision >= 1) {
            ctx.drawImage(windows, computer_screen.px, computer_screen.py, computer_screen.width, computer_screen.height);
            computer_on = true
        }
        
        ctx.drawImage(hero, player.px, player.py, player.width, player.height);

        let objects = [floor, computer, computer_screen, tv, tv_screen, nes, left_wall, right_wall, ceiling, cabnet, ceiling2, ceiling3, bed, painting, rail, rail2, stairs]
        let debug = false
        if (debug) {
            for (let i=0; i<objects.length; ++i) {
                ctx.fillStyle = 'rgba(188,143,143,0.7)';
                ctx.fillRect(objects[i].px, objects[i].py, objects[i].width, objects[i].height);
            }
        }
    }
    draw()
    window.requestAnimationFrame(main_loop);
    
    //animation function
    function main_loop() {

        // }
        if (check_collision(player, ceiling)) {
            collision_sound()
            player.py += 5.3
   
        } else if (check_collision(player, cabnet)) {
            collision_sound()
            cabnet_collision += 1
            player.py += 5.3
        } else if (check_collision(player, ceiling3)) {
            collision_sound()
            player.py += 5.3
        } else if (check_collision(player, ceiling2)) {
            collision_sound()
            player.py += 5.3
        } else if (check_collision(player, painting)) {
            collision_sound()
            painting_collision += 1
            player.py += 5.3
        } else if (check_collision(player, rail)) {
            collision_sound()
            if (player.px >= 478) {
                player.px += 5.3
            }else {
                player.py += 5.3
            }

        } else if (check_collision(player, rail2)) {
            collision_sound()
            rail2_collision += 1
            player.px -= 5.3
        } else if (check_collision(player, stairs)) {
            play_music()
            teleport_sound()
            player.py = 220
            player.px = 170
            stair_collision += 1
  
        } else if (check_collision(lucario, stairs)) {
           
            lucario_collision += 1
            lucario.py = 220
            lucario.px = 170
            lucario.vy = -15
            lucario_is = false
            teleport_sound()
            
         
        } else if (check_collision(player, floor)) {
            collision_sound()
            player.py -= 5.3
        } else if (check_collision(player, right_wall)) {
            collision_sound()
            player.px -= 5.3
        } else if (check_collision(player, left_wall)) {
            collision_sound()
            player.px += 5.3
        } else if (check_collision(player, bed)) {
            bed_contact()
        } else if (check_collision(player, computer)) {
            if (computer_on) {
                lucario_mission()
            } else {
                computer_contact()
            }
        } else if (check_collision(player, tv)) {
            collision_sound()
            if (player.vx > 290) {
                player.px += 5.3
            }else {
                player.px -= 5.3
            }
        }else if (check_collision(player, nes)) {
            nes_contact()
        }else if (check_collision(player, dusk_ball)) {
            if (duskball_is) {
                teleport_sound()
                player.py = 300
                player.px = 520
                stair_collision = 0
                duskball_collision += 1
                duskball_is = false
            }
        }else if (check_collision(player, haunted_painting)) {
            if (haunted_painting_is) {
                teleport_sound()
                player.py = 220
                player.px = 170
                haunted_collision += 1   
                haunted_painting_is = false
            }
        }else if (check_collision(player, lucario)) {
            if (lucario_is) {
                lucario_contact()
            }
           
        } else {
            close_computer.onclick() 
            close_nes.onclick()
            close_logout.onclick()
            close_lucario.onclick()
            close_load.onclick()  
        }
 
        player.px += player.vx
        player.py += player.vy

        lucario.px += lucario.vx
        lucario.py += lucario.vy

        draw()
        window.requestAnimationFrame(main_loop);
    }


    // function for calculating the overlap between two rectangles
    function check_collision(rect1, rect2) {
        let x_overlap = Math.max(0, Math.min(rect1.px + rect1.width, rect2.px + rect2.width) - Math.max(rect1.px, rect2.px))
        let y_overlap = Math.max(0, Math.min(rect1.py + rect1.height, rect2.py + rect2.height) - Math.max(rect1.py, rect2.py))
        let overlapArea = x_overlap * y_overlap
        return overlapArea != 0
    }



    //keyboard commands
    document.body.onkeydown = function(e) {
        if (e.keyCode == 32 || e.keyCode == 38 || e.keyCode == 87) {
            player.py -= 11.3
        }
        if (player.vx == 0){
            if (e.keyCode == 65 || e.keyCode == 37) {
                player.px -= 11.3
            } else if (e.keyCode == 68 || e.keyCode == 39) {
                player.px += 11.3
            } else if (e.keyCode == 40 || e.keyCode == 83) {
                player.py += 11.3
            }
        }
    }

    //speech recognition function
    start_listening.onclick = function () {
        if ('webkitSpeechRecognition' in window) {
            var speechRecognizer = new webkitSpeechRecognition();

            //set rules for speech recognition 
            speechRecognizer.continuous = true;
            speechRecognizer.interimResults = true;
            speechRecognizer.lang = 'en-US';

            //start speech recognition function 
            speechRecognizer.start();

            //function to process speech recognition results 
            speechRecognizer.onresult = function(event) {
                var last = event.results.length - 1;
                var command = event.results[last][0].transcript;

                //display results on screen 
                speech_results.textContent = 'Voice Input: ' + command + '.';

                //dom manipulation based on commands 
                command = command.toLowerCase()
                if (command === 'up' || command[0] == 'u') {
                    player.py -= 15.3
                    draw()
                    start_listening.onclick()
                    speechRecognizer.start();
                } else if (command === 'left' || command[0] == 'left') {
                    player.px -= 15.3
                    draw()
                    start_listening.onclick()
                    speechRecognizer.start();
                } else if (command === 'right' || command[0] == 'r') {
                    player.px += 15.3
                    draw()
                    start_listening.onclick()
                    speechRecognizer.start();
                } else if (command === 'down' || command[0] == 'd') {
                    player.py += 15.3
                    draw()
                } else {
                }
            }
        }
    };
</script>
{% endblock %}